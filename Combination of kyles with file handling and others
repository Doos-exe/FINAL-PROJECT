#include <iostream>
#include <queue>
#include <stack>
#include <map>
#include <fstream>
#include <string>
#include <vector>
#include <limits>
#include <windows.h>
using namespace std;

struct Customer {
    int customerID;
    string name;
    string address;
};

struct Video {
    int videoID;
    string title;
    string genre;
    string production;
    int numberOfCopies;
};

class CustomerADT {
public:
    queue<Customer> customers;
    int nextCustomerID;

public:
    CustomerADT()
        : nextCustomerID(1) {}

    void addCustomer(const string& name, const string& address) {
        Customer newCustomer = {nextCustomerID++, name, address};
        customers.push(newCustomer);
        saveNewCustomerToFile(newCustomer);
        system("cls");

        cout << "Customer added successfully!\n";
        cout << "Customer ID: " << newCustomer.customerID << endl;
        cout << "Name       : " << newCustomer.name << endl;
        cout << "Address    : " << newCustomer.address << '\n' << endl;
    }

    void showCustomerDetails(int customerID) {
        queue<Customer> tempQueue = customers;
        bool found = false;

        while (!tempQueue.empty()) {
            Customer current = tempQueue.front();
            tempQueue.pop();
            if (current.customerID == customerID) {
                system("cls");
                cout << "Customer Details\n";
                cout << "Customer ID: " << current.customerID << "\n";
                cout << "Name: " << current.name << "\n";
                cout << "Address: " << current.address << "\n";
                system("pause");
                cout << "\n";
                found = true;
                break;
            }
        }

        if (!found) {
            system("cls");
            cout << "\nCustomer not found!\n\n";
            Sleep(500);
        }
    }

    void updateNextCustomerID() {
        int maxID = 0;
        queue<Customer> tempQueue = customers;
        while (!tempQueue.empty()) {
            Customer current = tempQueue.front();
            tempQueue.pop();
            if (current.customerID > maxID) {
                maxID = current.customerID;
            }
        }
        nextCustomerID = maxID + 1;
    }

    void saveNewCustomerToFile(const Customer& customer) {
        ofstream outfile("customers.txt", ios::app);
        if (outfile.is_open()) {
            outfile << customer.customerID << " " << customer.name << "," << customer.address << endl;
            outfile.close();
        }
    }

    void loadCustomersFromFile() {
        ifstream infile("customers.txt");
        if (infile.is_open()) {
            int id;
            string name, address;
            while (infile >> id >> ws && getline(infile, name, ',') && getline(infile, address)) {
                customers.push({id, name, address});
            }
            infile.close();
            updateNextCustomerID();
        }
    }
};

class VideoADT {
public:
    vector<Video> videos;
    int nextVideoID;

    VideoADT() : nextVideoID(1) {}

    void addVideo(const string& title, const string& genre, const string& production, int numberOfCopies) {
        Video newVideo = {nextVideoID++, title, genre, production, numberOfCopies};
        videos.push_back(newVideo);
        saveNewVideoToFile(newVideo);
        system("cls");

        cout << "Video added successfully!\n";
        cout << "Video ID      : " << newVideo.videoID << endl;
        cout << "Title         : " << newVideo.title << endl;
        cout << "Genre         : " << newVideo.genre << endl;
        cout << "Production    : " << newVideo.production << endl;
        cout << "No. of Copies : " << newVideo.numberOfCopies << '\n' << endl;
    }

    void showVideoDetails(int videoID) {
        bool found = false;
        for (const auto& video : videos) {
            if (video.videoID == videoID) {
                system("cls");
                cout << "Video Details\n";
                cout << "Video ID      : " << video.videoID << "\n";
                cout << "Title         : " << video.title << "\n";
                cout << "Genre         : " << video.genre << "\n";
                cout << "Production    : " << video.production << "\n";
                cout << "No. of Copies : " << video.numberOfCopies << "\n";
                system("pause");
                cout << "\n";
                found = true;
                break;
            }
        }
        if (!found) {
            system("cls");
            cout << "\nVideo not found!\n\n";
            Sleep(500);
        }
    }

    void saveNewVideoToFile(const Video& video) {
        ofstream outfile("videos.txt", ios::app);
        if (outfile.is_open()) {
            outfile << video.videoID << " " << video.title << "," << video.genre << "," << video.production << "," << video.numberOfCopies << endl;
            outfile.close();
        }
    }

    void updateNextVideoID() {
        int maxID = 0;
        for (const auto& video : videos) {
            if (video.videoID > maxID) {
                maxID = video.videoID;
            }
        }
        nextVideoID = maxID + 1;
    }

    void updateVideoCopies(int videoID, int change) {
        for (auto& video : videos) {
            if (video.videoID == videoID) {
                video.numberOfCopies += change;
                saveAllVideosToFile();
                break;
            }
        }
    }

    void saveAllVideosToFile() {
        ofstream outfile("videos.txt");
        if (outfile.is_open()) {
            for (const auto& video : videos) {
                outfile << video.videoID << " " << video.title << "," << video.genre << "," << video.production << "," << video.numberOfCopies << endl;
            }
            outfile.close();
        }
    }

    void loadVideosFromFile() {
        ifstream infile("videos.txt");
        if (infile.is_open()) {
            int id, copies;
            string title, genre, production;
            while (infile >> id >> ws && getline(infile, title, ',') && getline(infile, genre, ',') && getline(infile, production, ',') && infile >> copies) {
                videos.push_back({id, title, genre, production, copies});
            }
            infile.close();
            updateNextVideoID();
        }
    }
};


class CustomerRentADT {
private:
    struct Rent {
        int customerID;
        stack<int> rentedVideoIDs;
    };
public:
    map<int, Rent> customerRentals;

    void rentVideo(int customerID, int videoID, VideoADT& videoADT) {
        if (videoADT.videos[videoID - 1].numberOfCopies > 0) {
            customerRentals[customerID].customerID = customerID;
            customerRentals[customerID].rentedVideoIDs.push(videoID);
            videoADT.updateVideoCopies(videoID, -1);
            saveAllRentalsToFile();
            cout << "Video rented successfully!\n";
        } else {
            cout << "No copies available for rent!\n";
        }
    }

    void returnVideo(int customerID, int videoID, VideoADT& videoADT) {
        if (customerRentals.find(customerID) != customerRentals.end()) {
            stack<int> tempStack;
            bool videoFound = false;
            while (!customerRentals[customerID].rentedVideoIDs.empty()) {
                int top = customerRentals[customerID].rentedVideoIDs.top();
                customerRentals[customerID].rentedVideoIDs.pop();
                if (top == videoID) {
                    videoFound = true;
                } else {
                    tempStack.push(top);
                }
            }
            while (!tempStack.empty()) {
                customerRentals[customerID].rentedVideoIDs.push(tempStack.top());
                tempStack.pop();
            }
            if (videoFound) {
                videoADT.updateVideoCopies(videoID, +1);
                saveAllRentalsToFile();
                cout << "Video returned successfully!\n";
            } else {
                cout << "The customer did not rent this video!\n";
            }
        } else {
            cout << "Customer not found!\n";
        }
    }

    void printRentedVideos(int customerID, const queue<Customer>& customers) {
        bool customerExists = false;
        queue<Customer> tempQueue = customers;
        while (!tempQueue.empty()) {
            if (tempQueue.front().customerID == customerID) {
                customerExists = true;
                break;
            }
            tempQueue.pop();
        }

        if (customerExists) {
            if (customerRentals.find(customerID) != customerRentals.end() && !customerRentals[customerID].rentedVideoIDs.empty()) {
                stack<int> tempStack = customerRentals[customerID].rentedVideoIDs;
                system("cls");
                cout << "List of Videos Rented by Customer ID: " << customerID << "\n";
                while (!tempStack.empty()) {
                    cout << "Video ID: " << tempStack.top() << "\n";
                    tempStack.pop();
                }
                system("pause");
            } else {
                system("cls");
                cout << "This customer has not rented any videos.\n\n";
                Sleep(500);
            }
        } else {
            system("cls");
            cout << "Customer not found!\n\n";
            Sleep(500);
        }
    }

    const map<int, Rent>& getCustomerRentals() const {
        return customerRentals;
    }

    void saveAllRentalsToFile() {
        ofstream outfile("rentals.txt");
        if (outfile.is_open()) {
            for (const auto& [customerID, rent] : customerRentals) {
                stack<int> tempStack = rent.rentedVideoIDs;
                while (!tempStack.empty()) {
                    outfile << customerID << " " << tempStack.top() << endl;
                    tempStack.pop();
                }
            }
            outfile.close();
        }
    }

    void loadRentalsFromFile() {
        ifstream infile("rentals.txt");
        if (infile.is_open()) {
            int customerID, videoID;
            while (infile >> customerID >> videoID) {
                customerRentals[customerID].customerID = customerID;
                customerRentals[customerID].rentedVideoIDs.push(videoID);
            }
            infile.close();
        }
    }
};


int main() {
    CustomerADT customerADT;
    VideoADT videoADT;
    CustomerRentADT customerRentADT;

    customerADT.loadCustomersFromFile();
    videoADT.loadVideosFromFile();
    customerRentADT.loadRentalsFromFile();

    int choice;
    do {
        system("cls");
        cout << "Video Rental System\n";
        cout << "[1] Add New Customer\n";
        cout << "[2] View Customer Details\n";
        cout << "[3] View Customer Rental History\n";
        cout << "[4] Add New Video\n";
        cout << "[5] View Video Details\n";
        cout << "[6] Rent a Video\n";
        cout << "[7] Return a Video\n";
        cout << "[8] Exit\n";
        cout << "Enter your choice: ";
        
        while (!(cin >> choice)) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "Invalid input. Please enter a number: ";
        }
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');

        switch (choice) {
            case 1: {
                string name, address;
                cout << "Enter Name: ";
                getline(cin, name);
                cout << "Enter Address: ";
                getline(cin, address);
                customerADT.addCustomer(name, address);
                break;
            }
            case 2: {
                int customerID;
                cout << "Enter Customer ID: ";
                while (!(cin >> customerID)) {
                    cin.clear();
                    cin.ignore(numeric_limits<streamsize>::max(), '\n');
                    cout << "Invalid input. Please enter a number: ";
                }
                customerADT.showCustomerDetails(customerID);
                break;
            }
            case 3: {
                int customerID;
                cout << "Enter Customer ID: ";
                while (!(cin >> customerID)) {
                    cin.clear();
                    cin.ignore(numeric_limits<streamsize>::max(), '\n');
                    cout << "Invalid input. Please enter a number: ";
                }
                customerRentADT.printRentedVideos(customerID, customerADT.customers);
                break;
            }
            case 4: {
                string title, genre, production;
                int numberOfCopies;
                cout << "Enter Title: ";
                getline(cin, title);
                cout << "Enter Genre: ";
                getline(cin, genre);
                cout << "Enter Production: ";
                getline(cin, production);
                cout << "Enter Number of Copies: ";
                while (!(cin >> numberOfCopies)) {
                    cin.clear();
                    cin.ignore(numeric_limits<streamsize>::max(), '\n');
                    cout << "Invalid input. Please enter a number: ";
                }
                cin.clear();
                cin.ignore(numeric_limits<streamsize>::max(), '\n');
                videoADT.addVideo(title, genre, production, numberOfCopies);
                break;
            }
            case 5: {
                int videoID;
                cout << "Enter Video ID: ";
                while (!(cin >> videoID)) {
                    cin.clear();
                    cin.ignore(numeric_limits<streamsize>::max(), '\n');
                    cout << "Invalid input. Please enter a number: ";
                }
                videoADT.showVideoDetails(videoID);
                break;
            }
            case 6: {
                int customerID, videoID;
                cout << "Enter Customer ID: ";
                while (!(cin >> customerID)) {
                    cin.clear();
                    cin.ignore(numeric_limits<streamsize>::max(), '\n');
                    cout << "Invalid input. Please enter a number: ";
                }
                cout << "Enter Video ID: ";
                while (!(cin >> videoID)) {
                    cin.clear();
                    cin.ignore(numeric_limits<streamsize>::max(), '\n');
                    cout << "Invalid input. Please enter a number: ";
                }
                customerRentADT.rentVideo(customerID, videoID, videoADT);
                break;
            }
            case 7: {
                int customerID, videoID;
                cout << "Enter Customer ID: ";
                while (!(cin >> customerID)) {
                    cin.clear();
                    cin.ignore(numeric_limits<streamsize>::max(), '\n');
                    cout << "Invalid input. Please enter a number: ";
                }
                cout << "Enter Video ID: ";
                while (!(cin >> videoID)) {
                    cin.clear();
                    cin.ignore(numeric_limits<streamsize>::max(), '\n');
                    cout << "Invalid input. Please enter a number: ";
                }
                customerRentADT.returnVideo(customerID, videoID, videoADT);
                break;
            }
            case 8:
                system("cls");
                cout << "Exiting the program...\n";
                break;
            default:
                system("cls");
                cout << "Invalid choice! Please enter a valid option.\n";
                Sleep(500);
                break;
        }
    } while (choice != 8);

    return 0;
}
